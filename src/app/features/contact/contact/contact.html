<div class="contact-hero">
  <div class="contact-container">
    <p-toast></p-toast>
    <app-loading-spinner
      [active]="loading"
      message="Sending your message..."
    ></app-loading-spinner>

    <section class="gp-intake" aria-labelledby="gp-intake-title">
      <h2 id="gp-intake-title">Start with the gitPlumbers App</h2>
      <p class="gp-intake__lead">
        Install the GitHub App, paste your installation ID, and choose the repository we should triage. The automation will
        label and assign it immediately.
      </p>
      <ol class="gp-intake__steps">
        <li class="gp-intake__step">
          <span class="gp-intake__badge">1</span>
          <div>
            <h3>Install gitPlumbers Assistant</h3>
            <p>
              Decide the access level (issues only, read code, or workflows) and authorize the app for the affected repo.
            </p>
            <a
              class="gp-intake__link"
              [href]="githubAppInstallUrl"
              target="_blank"
              rel="noopener noreferrer"
            >Install GitHub App</a>
            <a
              class="gp-intake__secondary"
              [href]="githubAppListingUrl"
              target="_blank"
              rel="noopener noreferrer"
            >View permissions</a>
          </div>
        </li>
        <li class="gp-intake__step">
          <span class="gp-intake__badge">2</span>
          <div>
            <h3>Select the repository for your ticket</h3>
            <p>
              Paste the installation ID GitHub shows you after installation, load the repositories you granted, and pick the one we
              should work on.
            </p>
            <form class="gp-intake__repo-form" [formGroup]="repoForm" (ngSubmit)="loadInstallationRepos()">
              <label class="gp-intake__label" for="installationId">Installation ID</label>
              <div class="gp-intake__row">
                <input
                  id="installationId"
                  type="text"
                  formControlName="installationId"
                  placeholder="12345678"
                  inputmode="numeric"
                  autocomplete="off"
                  aria-describedby="installation-hint"
                />
                <p-button
                  label="Load repositories"
                  type="submit"
                  styleClass="gp-intake__load-button"
                  [disabled]="repoForm.controls['installationId'].invalid || repoLoading"
                  [loading]="repoLoading"
                ></p-button>
              </div>
              <div id="installation-hint" class="gp-intake__hint">
                GitHub includes <code>installation_id=...</code> in the URL when it redirects you back here.
                <div class="gp-intake__button-group">
                  <button 
                    type="button" 
                    class="gp-intake__load-button"
                    (click)="loadInstallationIdFromStorage()"
                    *ngIf="!repoForm.controls['installationId'].value"
                  >
                    Load Saved Installation ID
                  </button>
                  <button 
                    type="button" 
                    class="gp-intake__clear-button"
                    (click)="clearInstallationData()"
                    *ngIf="repoForm.controls['installationId'].value"
                  >
                    Clear Installation Data
                  </button>
                </div>
              </div>
              <div *ngIf="repoError" class="gp-intake__error">{{ repoError }}</div>
              <div
                *ngIf="!repoLoading && repoFormSubmitted && !repoError && repositories.length === 0"
                class="gp-intake__hint"
              >
                No repositories returned for that installation. Verify access in GitHub → Settings → Applications.
              </div>
              <ng-container *ngIf="repositories.length > 0">
                <label class="gp-intake__label" for="repoFullName">Repository</label>
                <select id="repoFullName" formControlName="repoFullName" class="gp-intake__select">
                  <option value="" disabled>Select a repository</option>
                  <option *ngFor="let repo of repositories" [value]="repo.fullName">
                    {{ repo.fullName }}
                  </option>
                </select>
              </ng-container>
            </form>
            <a
              class="gp-intake__link gp-intake__link--primary"
              [class.gp-intake__link--disabled]="!selectedRepoIssueLink"
              [attr.href]="selectedRepoIssueLink || null"
              target="_blank"
              rel="noopener noreferrer"
            >
              Open gitPlumbers ticket
            </a>
          </div>
        </li>
      </ol>
      <p class="gp-intake__footer">
        Need an NDA or want to brief us first? Use the form below and we'll coordinate access manually.
      </p>
    </section>
    <div class="contact-card">
      <header class="card-head">
        <h2 class="title">Contact Us</h2>
        <p class="subtitle">Tell us what you're working on—we'll get back fast.</p>
      </header>

      <form [formGroup]="contactForm" (ngSubmit)="onSubmit()" novalidate [attr.aria-busy]="loading">
        <div class="form-grid">
          <!-- Name -->
          <div class="field">
            <span class="p-input-icon-left p-float-label field-control">
              <i class="pi pi-user"></i>
              <input id="name" type="text" pInputText formControlName="name" />
              <label for="name">Full name</label>
            </span>
          </div>

          <!-- Email -->
          <div class="field">
            <span class="p-input-icon-left p-float-label field-control">
              <i class="pi pi-envelope"></i>
              <input id="email" type="email" pInputText formControlName="email" />
              <label for="email">Work email</label>
            </span>
          </div>

          <!-- Message -->
          <div class="field">
            <span class="p-input-icon-left p-float-label field-control">
              <textarea id="message" pTextarea rows="5" formControlName="message"></textarea>
              <label for="message">How can we help?</label>
            </span>
            <small class="hint">Be as specific as you like.</small>
          </div>

          <!-- GitHub Repo -->
          <div class="field">
            <span class="p-input-icon-left p-float-label field-control">
              <i class="pi pi-github"></i>
              <input id="githubRepo" type="text" pInputText formControlName="githubRepo" />
              <label for="githubRepo">GitHub repo (optional)</label>
            </span>
            <small class="hint">Use <code>user/repo</code> or a full URL.</small>
          </div>

          <!-- Attachment -->
          <div class="field">
            <label class="field-label">Attachment (optional, .zip)</label>
            <p-fileUpload
              name="attachment"
              (onSelect)="onUpload($event)"
              accept=".zip"
              [showUploadButton]="false"
              mode="basic"
              chooseLabel="Choose .zip"
              class="upload-basic"
            ></p-fileUpload>
            <small class="muted">Max 20MB. Drag &amp; drop supported.</small>
          </div>
        </div>

        <div class="actions">
          <p-button
            icon="pi pi-arrow-left"
            label="Back"
            styleClass="p-button-text"
            routerLink="/"
            type="button"
          ></p-button>
          <p-button
            icon="pi pi-send"
            iconPos="right"
            label="Submit"
            type="submit"
            [disabled]="contactForm.invalid || loading"
          ></p-button>
        </div>
      </form>
    </div>
  </div>
</div>
