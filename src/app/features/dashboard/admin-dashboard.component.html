@if (profile(); as admin) {
<div class="admin-shell">
  <section class="admin-hero">
    <div class="hero-copy">
      <p class="hero-eyebrow">Admin control</p>
      <h1>On-call for the gitPlumbers crew</h1>
      <p class="hero-body">
        Review every incoming request, nudge statuses forward, and keep customers in the loop with
        live notes.
      </p>
      <div class="admin-actions">
        <a routerLink="/support-requests" class="admin-link">
          <i class="pi pi-inbox"></i>
          View Support Requests
        </a>
        <a routerLink="/ai-analytics" class="admin-link">
          <i class="pi pi-chart-line"></i>
          AI Analytics Dashboard
        </a>
      </div>
    </div>
    <div class="hero-meta">
      <span class="badge">Signed in as {{ admin.displayName || admin.email }}</span>
    </div>
  </section>

  <!-- User Filter Section -->
  @if (userOptions().length > 0) {
    <section class="filter-section">
      <div class="filter-controls">
        <div class="filter-group">
          <label for="user-filter">Filter by users:</label>
          <p-multiSelect
            id="user-filter"
            [options]="userOptions()"
            [ngModel]="selectedUserEmailsValue"
            (ngModelChange)="onUserFilterChange($event)"
            optionLabel="label"
            optionValue="value"
            placeholder="All users (no filter)"
            [showToggleAll]="true"
            [filter]="true"
            filterPlaceholder="Search users..."
            styleClass="user-filter-multiselect"
            [maxSelectedLabels]="3"
            selectedItemsLabel="{0} users selected"
          ></p-multiSelect>
        </div>
        @if (selectedUserEmailsValue.length > 0) {
          <button
            type="button"
            class="clear-filter-btn"
            (click)="clearUserFilter()"
            title="Show all users"
          >
            <i class="pi pi-times"></i>
            Clear filter
          </button>
        }
      </div>
      <div class="filter-summary">
        @if (selectedUserEmailsValue.length === 0) {
          <span>Showing all {{ filteredItems().length }} items from {{ userOptions().length }} users</span>
        } @else {
          <span>Showing {{ filteredItems().length }} items from {{ selectedUserEmailsValue.length }} selected user(s)</span>
        }
      </div>
    </section>
  }

  @if (hasRequests()) {
  <section class="requests-board">
    @for (item of filteredItems(); track item.id) {
    <article class="request">
      <header class="request-header">
        <div class="request-owner">
          <h2>{{ item.userName || item.userEmail }}</h2>
          <p>{{ item.userEmail }}</p>
          @if (item.type === 'github') {
            <span class="request-type-badge github">GitHub Issue</span>
          } @else {
            <span class="request-type-badge support">Support Request</span>
          }
        </div>
        <div class="request-status">
          <label>
            <span>Status</span>
            <select
              [disabled]="isStatusBusy(item.id)"
              [ngModel]="item.status"
              (ngModelChange)="changeStatus(item.id, $event)"
            >
              @for (option of statusOptions; track option.value) {
              <option [value]="option.value">
                {{ option.label }}
              </option>
              }
            </select>
          </label>
        </div>
      </header>

      <div class="request-body">
        <p class="timestamp">Opened {{ formatTimestamp(item.createdAt) }}</p>
        @if (item.type === 'github') {
          <h3 class="issue-title">{{ item.title }}</h3>
          <div class="message markdown-content" [innerHTML]="item.message | markdown"></div>
        } @else {
          <p class="message">{{ item.message }}</p>
        }
        @if (item.type === 'github' && item.githubIssueUrl) {
          <p class="meta">
            <a [href]="item.githubIssueUrl" target="_blank" rel="noopener noreferrer">
              View on GitHub: {{ item.repository }}
            </a>
          </p>
        } @else if (item.type === 'support' && item.githubRepo) {
          <p class="meta">Repo: {{ item.githubRepo }}</p>
        }
      </div>

      @if (item.notes.length) {
      <section class="notes">
        <h3>Notes</h3>
        @for (note of item.notes; track note.createdAt) {
        <article class="note">
          <div class="note-meta">
            <strong>{{ note.authorName }}</strong>
            <span class="role">{{ note.role | titlecase }}</span>
            <span class="time">{{ formatTimestamp(note.createdAt) }}</span>
          </div>
          <p>{{ note.message }}</p>
        </article>
        }
      </section>
      }

      <section class="note-editor">
        <label>
          <span>Add an update</span>
          <textarea
            rows="3"
            [value]="noteDraft(item.id)"
            (input)="updateDraft(item.id, $any($event.target).value)"
            placeholder="Share status changes, blockers, or next steps."
          ></textarea>
        </label>
        <button
          type="button"
          (click)="sendNote(item.id)"
          [disabled]="isNoteBusy(item.id) || !noteDraft(item.id).trim()"
        >
          {{ isNoteBusy(item.id) ? 'Sending...' : 'Post update' }}
        </button>
      </section>
    </article>
    }
  </section>
  } @else {
  <div class="admin-empty">
    <p>No requests or GitHub issues yet. Once customers submit from their dashboard, they'll show up here.</p>
  </div>
  }
</div>
} @else {
<div class="admin-loading">Loading the admin console.</div>
}
