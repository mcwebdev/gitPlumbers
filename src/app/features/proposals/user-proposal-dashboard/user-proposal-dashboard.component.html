<div class="user-proposal-dashboard">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Header -->
  <div class="header-section">
    <div class="header-content">
      <h1>{{ currentUser()?.displayName || 'My' }} Proposals</h1>
      <p class="subtitle">Review proposals sent to you by GitPlumbers</p>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <p-card>
      <div class="stat-card">
        <div class="stat-value">{{ stats().total }}</div>
        <div class="stat-label">Total Proposals</div>
      </div>
    </p-card>
    <p-card>
      <div class="stat-card pending">
        <div class="stat-value">{{ stats().pending }}</div>
        <div class="stat-label">Pending Review</div>
      </div>
    </p-card>
    <p-card>
      <div class="stat-card revision">
        <div class="stat-value">{{ stats().revisionRequested }}</div>
        <div class="stat-label">Revision Requested</div>
      </div>
    </p-card>
    <p-card>
      <div class="stat-card accepted">
        <div class="stat-value">{{ stats().accepted }}</div>
        <div class="stat-label">Accepted</div>
      </div>
    </p-card>
    <p-card>
      <div class="stat-card rejected">
        <div class="stat-value">{{ stats().rejected }}</div>
        <div class="stat-label">Rejected</div>
      </div>
    </p-card>
  </div>

  <!-- Inline Proposal Detail View (slides up above table) -->
  @if (selectedProposal(); as proposal) {
    <div class="proposal-detail-container" [class.visible]="showProposalDetail()">
      <div class="proposal-detail-header">
        <h2>{{ proposal.title }}</h2>
        <button
          class="close-button"
          (click)="onCloseProposalDetail()"
          aria-label="Close proposal detail">
          <i class="pi pi-times"></i>
        </button>
      </div>

      <div class="proposal-details">
        <!-- Status Badge -->
        <div class="status-banner" [class]="proposal.status">
          <p-tag
            [value]="proposal.status | titlecase"
            [severity]="getStatusSeverity(proposal.status)"
            styleClass="status-tag-large">
          </p-tag>
        </div>

        <!-- Metadata -->
        <div class="detail-row">
          <strong>Date Received:</strong>
          <span>{{ formatDate(proposal.createdAt) }}</span>
        </div>
        @if (proposal.sentAt) {
          <div class="detail-row">
            <strong>Date Sent:</strong>
            <span>{{ formatDate(proposal.sentAt) }}</span>
          </div>
        }
        @if (proposal.description) {
          <div class="detail-row">
            <strong>Description:</strong>
            <p>{{ proposal.description }}</p>
          </div>
        }

        <p-divider></p-divider>

        <!-- Line Items -->
        <h3>Proposed Services</h3>
        @for (item of proposal.items; track $index) {
          <div class="line-item">
            <div class="item-header">
              <strong>{{ item.productName }}</strong>
              <span class="item-total">{{ formatAmount(item.unitAmount * item.quantity, item.currency) }}</span>
            </div>
            @if (item.description) {
              <p class="item-description">{{ item.description }}</p>
            }
            <div class="item-footer">
              <span>{{ formatAmount(item.unitAmount, item.currency) }} Ã— {{ item.quantity }}</span>
            </div>
          </div>
        }

        <p-divider></p-divider>

        <!-- Total -->
        <div class="total-row">
          <strong>Total Amount:</strong>
          <strong class="total-amount">{{ formatAmount(proposal.totalAmount, proposal.currency) }}</strong>
        </div>

        <!-- Notes Section -->
        <p-divider></p-divider>
        <h3>Notes & Communication</h3>

        @if (proposal.notes && proposal.notes.length > 0) {
          <div class="notes-list">
            @for (note of proposal.notes; track note.id) {
              <div class="note-item">
                <div class="note-header">
                  <strong>{{ note.authorName }}</strong>
                  <span class="note-role" [class]="note.role">{{ note.role | titlecase }}</span>
                  <span class="note-date">{{ formatDate(note.createdAt) }}</span>
                </div>
                <p class="note-message">{{ note.message }}</p>
              </div>
            }
          </div>
        } @else {
          <p class="no-notes">No notes yet. Add a note to communicate with GitPlumbers.</p>
        }

        <!-- Add Note Form -->
        <div class="add-note-section">
          <label for="user-note">Add a note:</label>
          <textarea
            pTextarea
            id="user-note"
            [(ngModel)]="userNoteText"
            rows="3"
            placeholder="Type your message..."
            class="w-full">
          </textarea>
          <p-button
            label="Add Note"
            icon="pi pi-send"
            (onClick)="onAddUserNote()"
            [disabled]="!userNoteText().trim()"
            [loading]="isLoading()"
            size="small"
            styleClass="mt-2">
          </p-button>
        </div>
      </div>

      <!-- Action Footer -->
      <div class="proposal-detail-footer">
        @if (canRequestRevision(proposal)) {
          <p-button
            label="Request Changes"
            icon="pi pi-pencil"
            (onClick)="onRequestRevision(proposal)"
            [outlined]="true"
            severity="secondary">
          </p-button>
        }
        @if (canReject(proposal)) {
          <p-button
            label="Reject"
            icon="pi pi-times"
            (onClick)="onRejectProposal(proposal)"
            severity="danger"
            [outlined]="true">
          </p-button>
        }
        @if (canAccept(proposal)) {
          <p-button
            label="Accept Proposal"
            icon="pi pi-check"
            (onClick)="onAcceptProposal(proposal)"
            severity="success">
          </p-button>
        }
        <p-button
          label="Close"
          (onClick)="onCloseProposalDetail()"
          [outlined]="true">
        </p-button>
      </div>
    </div>
  }

  <!-- Proposals Table (Desktop) -->
  <p-card class="proposals-table-desktop">
    <p-table
      [value]="proposals()"
      [paginator]="true"
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} proposals"
      [rowsPerPageOptions]="[10, 25, 50]"
      [loading]="isLoading()"
      styleClass="p-datatable-gridlines">
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="title">
            Title
            <p-sortIcon field="title"></p-sortIcon>
          </th>
          <th pSortableColumn="totalAmount">
            Amount
            <p-sortIcon field="totalAmount"></p-sortIcon>
          </th>
          <th pSortableColumn="status">
            Status
            <p-sortIcon field="status"></p-sortIcon>
          </th>
          <th pSortableColumn="createdAt">
            Date Received
            <p-sortIcon field="createdAt"></p-sortIcon>
          </th>
          <th>Actions</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-proposal>
        <tr>
          <td>
            <div class="proposal-title">
              {{ proposal.title }}
              @if (proposal.status === 'sent') {
                <span class="new-badge">NEW</span>
              }
            </div>
          </td>
          <td>{{ formatAmount(proposal.totalAmount, proposal.currency) }}</td>
          <td>
            <p-tag
              [value]="proposal.status | titlecase"
              [severity]="getStatusSeverity(proposal.status)">
            </p-tag>
          </td>
          <td>{{ formatDate(proposal.createdAt) }}</td>
          <td>
            <div class="action-buttons">
              <p-button
                label="View"
                icon="pi pi-eye"
                (onClick)="onViewProposal(proposal)"
                [outlined]="true"
                size="small">
              </p-button>
            </div>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="text-center">
            <div class="empty-state">
              <i class="pi pi-inbox" style="font-size: 3rem; color: var(--surface-400);"></i>
              <p>No proposals yet. When GitPlumbers sends you a proposal, it will appear here.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Proposals Cards (Mobile) -->
  <div class="proposals-cards-mobile">
    @if (proposals().length === 0) {
      <div class="empty-state">
        <i class="pi pi-inbox" style="font-size: 3rem; color: var(--surface-400);"></i>
        <p>No proposals yet. When GitPlumbers sends you a proposal, it will appear here.</p>
      </div>
    } @else {
      @for (proposal of proposals(); track proposal.id) {
        <p-card class="proposal-card-mobile">
          <div class="mobile-card-header">
            <div class="mobile-card-title">
              <h3>{{ proposal.title }}</h3>
              @if (proposal.status === 'sent') {
                <span class="new-badge">NEW</span>
              }
            </div>
            <p-tag
              [value]="proposal.status | titlecase"
              [severity]="getStatusSeverity(proposal.status)">
            </p-tag>
          </div>
          <div class="mobile-card-content">
            <div class="mobile-card-row">
              <span class="mobile-label">Amount:</span>
              <span class="mobile-value">{{ formatAmount(proposal.totalAmount, proposal.currency) }}</span>
            </div>
            <div class="mobile-card-row">
              <span class="mobile-label">Date Received:</span>
              <span class="mobile-value">{{ formatDate(proposal.createdAt) }}</span>
            </div>
          </div>
          <div class="mobile-card-footer">
            <p-button
              label="View Details"
              icon="pi pi-eye"
              (onClick)="onViewProposal(proposal)"
              [outlined]="true"
              size="small"
              styleClass="w-full">
            </p-button>
          </div>
        </p-card>
      }
    }
  </div>


  <!-- Revision Request Dialog -->
  <p-dialog
    [(visible)]="showRevisionDialog"
    [modal]="true"
    [style]="{width: '40vw'}"
    [breakpoints]="{'960px': '60vw', '640px': '90vw'}"
    header="Request Changes">
    <div class="revision-dialog-content">
      <p class="dialog-description">
        Please describe what changes you'd like to see in this proposal. Your feedback will be sent to the GitPlumbers team.
      </p>
      <label for="revision-notes">What changes do you need? *</label>
      <textarea
        pTextarea
        id="revision-notes"
        [(ngModel)]="revisionNotes"
        rows="5"
        placeholder="e.g., Please adjust the timeline for the code review phase, or reduce the hourly rate..."
        class="w-full"
        autofocus>
      </textarea>
    </div>

    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <p-button
          label="Cancel"
          (onClick)="onCancelRevisionRequest()"
          [outlined]="true"
          severity="secondary">
        </p-button>
        <p-button
          label="Submit Request"
          icon="pi pi-send"
          (onClick)="onSubmitRevisionRequest()"
          [loading]="isLoading()">
        </p-button>
      </div>
    </ng-template>
  </p-dialog>

  <!-- Loading Spinner Overlay -->
  <app-loading-spinner 
    [active]="isLoading()" 
    message="Processing your request...">
  </app-loading-spinner>
</div>
