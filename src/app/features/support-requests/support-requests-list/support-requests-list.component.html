<div class="support-requests-container">
  <p-toolbar>
    <ng-template pTemplate="left">
      <h2>Support Requests</h2>
    </ng-template>
    <ng-template pTemplate="right">
      <p-button
        label="Refresh"
        icon="pi pi-refresh"
        (onClick)="refreshRequests()"
        [loading]="loading()"
      >
      </p-button>
    </ng-template>
  </p-toolbar>

  <!-- Error Message -->
  @if (error()) {
  <p-message severity="error" [text]="error()!" (onClose)="error.set(null)">
  </p-message>
  }

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <p-card>
      <ng-template pTemplate="header">
        <div class="stat-header">
          <i class="pi pi-inbox"></i>
          <span>Total</span>
        </div>
      </ng-template>
      <div class="stat-value">{{ requests().length }}</div>
    </p-card>

    <p-card>
      <ng-template pTemplate="header">
        <div class="stat-header">
          <i class="pi pi-clock"></i>
          <span>New</span>
        </div>
      </ng-template>
      <div class="stat-value">{{ getNewRequestsCount() }}</div>
    </p-card>

    <p-card>
      <ng-template pTemplate="header">
        <div class="stat-header">
          <i class="pi pi-cog"></i>
          <span>In Progress</span>
        </div>
      </ng-template>
      <div class="stat-value">{{ getInProgressRequestsCount() }}</div>
    </p-card>

    <p-card>
      <ng-template pTemplate="header">
        <div class="stat-header">
          <i class="pi pi-check"></i>
          <span>Completed</span>
        </div>
      </ng-template>
      <div class="stat-value">{{ getResolvedRequestsCount() }}</div>
    </p-card>
  </div>

  <!-- Filters -->
  <p-card class="filters-card">
    <ng-template pTemplate="header">
      <span>Filters</span>
    </ng-template>
    <div class="filters-grid">
      <div class="filter-item">
        <label for="statusFilter">Status:</label>
        <select
          id="statusFilter"
          [(ngModel)]="filters.status"
          (change)="applyFilters()"
          class="status-select"
        >
          <option value="">All Statuses</option>
          @for (option of statusOptions; track option.value) {
          <option [value]="option.value">
            {{ option.label }}
          </option>
          }
        </select>
      </div>

      <div class="filter-item">
        <label for="emailFilter">Email:</label>
        <input
          id="emailFilter"
          type="text"
          pInputText
          [(ngModel)]="filters.userEmail"
          placeholder="Filter by email"
          (input)="applyFilters()"
        />
      </div>

      <div class="filter-item">
        <label for="dateFromFilter">From Date:</label>
        <input
          id="dateFromFilter"
          type="date"
          [(ngModel)]="filters.dateFrom"
          (change)="applyFilters()"
          class="date-input"
        />
      </div>

      <div class="filter-item">
        <label for="dateToFilter">To Date:</label>
        <input
          id="dateToFilter"
          type="date"
          [(ngModel)]="filters.dateTo"
          (change)="applyFilters()"
          class="date-input"
        />
      </div>

      <div class="filter-actions">
        <p-button
          label="Clear Filters"
          icon="pi pi-times"
          severity="secondary"
          (onClick)="clearFilters()"
        >
        </p-button>
      </div>
    </div>
  </p-card>

  <!-- Requests Table -->
  <p-card>
    <ng-template pTemplate="header">
      <span>Support Requests ({{ requests().length }})</span>
    </ng-template>

    <app-loading-spinner [active]="loading()" [message]="'Loading support requests...'"></app-loading-spinner>

    @if (!loading()) {
    <p-table
      [value]="requests()"
      [paginator]="true"
      [rows]="10"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
      [rowsPerPageOptions]="[10, 25, 50]"
      styleClass="p-datatable-sm"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Message</th>
          <th>GitHub Repo</th>
          <th>Status</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-request>
        <tr>
          <td>
            <code class="request-id">{{ request.id.substring(0, 8) }}...</code>
          </td>
          <td>
            <div class="user-info">
              <div class="user-email">{{ request.userEmail }}</div>
              <small class="user-name">{{ request.userName }}</small>
            </div>
          </td>
          <td>
            <div class="message-preview">
              {{
                request.message.length > 50
                  ? request.message.substring(0, 50) + '...'
                  : request.message
              }}
            </div>
          </td>
          <td>
            <a [href]="request.githubRepo" target="_blank" class="repo-link">
              <i class="pi pi-external-link"></i>
              {{ getRepoName(request.githubRepo) }}
            </a>
          </td>
          <td>
            <p-tag [value]="request.status" [severity]="getStatusSeverity(request.status)"> </p-tag>
          </td>
          <td>
            <div class="date-info">
              <div>{{ formatDate(request.createdAt) }}</div>
              @if (formatDate(request.updatedAt) !== formatDate(request.createdAt)) {
              <small>
                Updated: {{ formatDate(request.updatedAt) }}
              </small>
              }
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <p-button
                icon="pi pi-eye"
                size="small"
                severity="info"
                [text]="true"
                pTooltip="View Details"
                (onClick)="viewRequest(request)"
              >
              </p-button>
              @if (request.status === 'new') {
              <p-button
                icon="pi pi-play"
                size="small"
                severity="success"
                [text]="true"
                pTooltip="Start Progress"
                (onClick)="updateStatus(request.id, 'in_progress')"
              >
              </p-button>
              }
              @if (request.status === 'in_progress') {
              <p-button
                icon="pi pi-check"
                size="small"
                severity="success"
                [text]="true"
                pTooltip="Mark Complete"
                (onClick)="updateStatus(request.id, 'resolved')"
              >
              </p-button>
              }
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center">
            <div class="empty-state">
              <i class="pi pi-inbox" style="font-size: 3rem; color: #ccc"></i>
              <p>No support requests found</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
    }
  </p-card>

  <!-- Request Detail Dialog -->
  <p-dialog
    header="Support Request Details"
    [(visible)]="showDetailDialog"
    [modal]="true"
    [style]="{ width: '80vw', maxWidth: '800px' }"
    [closable]="true"
  >
    @if (selectedRequest(); as request) {
    <div class="request-detail">
      <div class="detail-section">
        <h4>Request Information</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <label>ID:</label>
            <code>{{ request.id }}</code>
          </div>
          <div class="detail-item">
            <label>Status:</label>
            <p-tag [value]="request.status" [severity]="getStatusSeverity(request.status)"> </p-tag>
          </div>
          <div class="detail-item">
            <label>Created:</label>
            <span>{{ formatDate(request.createdAt) }}</span>
          </div>
          <div class="detail-item">
            <label>Updated:</label>
            <span>{{ formatDate(request.updatedAt) }}</span>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h4>User Information</h4>
        <div class="detail-grid">
          <div class="detail-item">
            <label>Email:</label>
            <span>{{ request.userEmail }}</span>
          </div>
          <div class="detail-item">
            <label>Name:</label>
            <span>{{ request.userName }}</span>
          </div>
          <div class="detail-item">
            <label>User ID:</label>
            <code>{{ request.userId }}</code>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h4>Request Details</h4>
        <div class="detail-item">
          <label>Message:</label>
          <p class="request-message">{{ request.message }}</p>
        </div>
        @if (request.githubRepo) {
        <div class="detail-item">
          <label>GitHub Repository:</label>
          <a [href]="request.githubRepo" target="_blank" class="repo-link">
            <i class="pi pi-external-link"></i>
            {{ request.githubRepo }}
          </a>
        </div>
        }
        @if (request.filePath) {
        <div class="detail-item">
          <label>File Path:</label>
          <code>{{ request.filePath }}</code>
        </div>
        }
      </div>

      <div class="detail-section">
        <h4>Notes ({{ request.notes.length }})</h4>
        <div class="notes-container">
          @for (note of request.notes; track note.id) {
          <div class="note-item">
            <div class="note-meta">
              <strong>{{ note.authorName }}</strong>
              <span class="role">{{ note.role | titlecase }}</span>
              <span class="time">{{ formatDate(note.createdAt) }}</span>
            </div>
            <div class="note-content">{{ note.message }}</div>
          </div>
          } @if (request.notes.length === 0) {
          <div class="no-notes">
            <p>No notes added yet.</p>
          </div>
          }
        </div>

        <div class="add-note-section">
          <textarea
            pInputTextarea
            [(ngModel)]="newNote"
            placeholder="Add a note..."
            rows="3"
            class="note-input"
          >
          </textarea>
          <p-button
            label="Add Note"
            icon="pi pi-plus"
            (onClick)="addNote()"
            [disabled]="!newNote().trim()"
          >
          </p-button>
        </div>
      </div>
    </div>
    }

    <ng-template pTemplate="footer">
      <div class="dialog-actions">
        @if (selectedRequest()?.status === 'new') {
        <p-button
          label="Start Progress"
          icon="pi pi-play"
          severity="success"
          (onClick)="updateStatus(selectedRequest()!.id, 'in_progress')"
        >
        </p-button>
        }
        @if (selectedRequest()?.status === 'in_progress') {
        <p-button
          label="Mark Complete"
          icon="pi pi-check"
          severity="success"
          (onClick)="updateStatus(selectedRequest()!.id, 'resolved')"
        >
        </p-button>
        }
        <p-button
          label="Close"
          icon="pi pi-times"
          severity="secondary"
          (onClick)="closeDetailDialog()"
        >
        </p-button>
      </div>
    </ng-template>
  </p-dialog>
</div>
